<div class="report-form-container">
  <!-- Header Section -->
  <div class="page-header">
    <div class="header-content">
      <div class="left-section">
        <div class="template-name" *ngIf="selectedTemplateName">
          <span class="template-label">{{ selectedTemplateName }}</span>
        </div>
      </div>
      <div class="header-info">
        <h1 class="page-title">Property Valuation for {{ selectedBankName }}</h1>
      </div>
      <div class="right-section">
        <button class="back-button" (click)="goBackToSelection()">
          ‚Üê Back to Selection
        </button>
      </div>
    </div>
  </div>

  <!-- Form Content -->
  <form [formGroup]="reportForm" (ngSubmit)="onSubmit()" class="report-form">
    
    <!-- Common Fields Section -->
    <div class="form-section" *ngIf="hasCommonFields()">
      <div class="section-header">
        <h2 class="section-title">Common Information</h2>
        <p class="section-subtitle">Basic details required for all valuation reports</p>
      </div>
      
      <!-- Loading indicator -->
      <div *ngIf="isLoading" class="loading-indicator">
        <div class="loading-spinner"></div>
        <p>Loading template fields: {{ selectedBankCode }}/{{ selectedTemplateId }}...</p>
        <small>Fetching common fields + bank-specific fields from server</small>
      </div>
      
      <!-- Common Field Groups -->
      <div *ngIf="!isLoading && hasCommonFields()" class="field-groups">
        <div *ngFor="let fieldGroup of getCommonFieldGroups()" class="field-group">
          <h3 class="field-group-title" *ngIf="fieldGroup.displayName !== 'Common Fields'">{{ fieldGroup.displayName }}</h3>
          
          <div class="fields-grid">
            <div *ngFor="let field of fieldGroup.fields" 
                 [class]="'field-container grid-' + field.gridSize"
                 [class.field-error]="isFieldInvalid(field.fieldId)">
              
              <!-- Text Input -->
              <div *ngIf="field.fieldType === 'text'" class="form-field">
                <label [for]="field.fieldId" class="field-label">
                  {{ field.uiDisplayName }}
                  <span class="required-indicator" *ngIf="field.isRequired">*</span>
                </label>
                <input
                  [id]="field.fieldId"
                  type="text"
                  [formControlName]="field.fieldId"
                  [placeholder]="field.placeholder"
                  [readonly]="field.isReadonly"
                  [class.readonly-field]="field.isReadonly"
                  class="form-input"
                />
                <div class="field-help" *ngIf="field.helpText">{{ field.helpText }}</div>
                <div class="field-error-message" *ngIf="getFieldError(field.fieldId)">
                  {{ getFieldError(field.fieldId) }}
                </div>
              </div>

              <!-- Date Input -->
              <div *ngIf="field.fieldType === 'date'" class="form-field">
                <label [for]="field.fieldId" class="field-label">
                  {{ field.uiDisplayName }}
                  <span class="required-indicator" *ngIf="field.isRequired">*</span>
                </label>
                <input
                  [id]="field.fieldId"
                  type="date"
                  [formControlName]="field.fieldId"
                  class="form-input"
                />
                <div class="field-help" *ngIf="field.helpText">{{ field.helpText }}</div>
                <div class="field-error-message" *ngIf="getFieldError(field.fieldId)">
                  {{ getFieldError(field.fieldId) }}
                </div>
              </div>

              <!-- Number/Currency Input -->
              <div *ngIf="field.fieldType === 'number' || field.fieldType === 'currency'" class="form-field">
                <label [for]="field.fieldId" class="field-label">
                  {{ field.uiDisplayName }}
                  <span class="required-indicator" *ngIf="field.isRequired">*</span>
                </label>
                <input
                  [id]="field.fieldId"
                  type="number"
                  [formControlName]="field.fieldId"
                  [placeholder]="field.placeholder"
                  [min]="field.validation?.min || null"
                  [max]="field.validation?.max || null"
                  class="form-input"
                />
                <div class="field-help" *ngIf="field.helpText">{{ field.helpText }}</div>
                <div class="field-error-message" *ngIf="getFieldError(field.fieldId)">
                  {{ getFieldError(field.fieldId) }}
                </div>
              </div>

              <!-- Textarea Input -->
              <div *ngIf="field.fieldType === 'textarea'" class="form-field">
                <label [for]="field.fieldId" class="field-label">
                  {{ field.uiDisplayName }}
                  <span class="required-indicator" *ngIf="field.isRequired">*</span>
                </label>
                <textarea
                  [id]="field.fieldId"
                  [formControlName]="field.fieldId"
                  [placeholder]="field.placeholder"
                  class="form-textarea"
                  rows="3"
                ></textarea>
                <div class="field-help" *ngIf="field.helpText">{{ field.helpText }}</div>
                <div class="field-error-message" *ngIf="getFieldError(field.fieldId)">
                  {{ getFieldError(field.fieldId) }}
                </div>
              </div>

              <!-- Select Input -->
              <div *ngIf="field.fieldType === 'select' || field.fieldType === 'select_dynamic'" class="form-field">
                <label [for]="field.fieldId" class="field-label">
                  {{ field.uiDisplayName }}
                  <span class="required-indicator" *ngIf="field.isRequired">*</span>
                </label>
                
                <!-- Regular select options -->
                <select 
                  *ngIf="field.fieldId !== 'bank_branch'"
                  [id]="field.fieldId"
                  [formControlName]="field.fieldId"
                  class="form-select">
                  <option value="">{{ field.placeholder || 'Select option' }}</option>
                  <option *ngFor="let option of field.options" [value]="option.value">
                    {{ option.label }}
                  </option>
                </select>
                
                <!-- Bank branch select (dynamic) -->
                <select 
                  *ngIf="field.fieldId === 'bank_branch'"
                  [id]="field.fieldId"
                  [formControlName]="field.fieldId"
                  class="form-select">
                  <option value="">{{ field.placeholder || 'Select branch' }}</option>
                  <option *ngFor="let branch of availableBranches" [value]="branch.value">
                    {{ branch.label }}
                  </option>
                </select>
                
                <div class="field-help" *ngIf="field.helpText">{{ field.helpText }}</div>
                <div class="field-error-message" *ngIf="getFieldError(field.fieldId)">
                  {{ getFieldError(field.fieldId) }}
                </div>
              </div>
              
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Tabs Section -->
    <div class="tabs-section">
      <div class="tabs-header">
        <button type="button" 
                class="tab-button" 
                [class.active]="activeTab === 'template'"
                (click)="switchTab('template')"
                [disabled]="!hasBankSpecificFields()">
          Bank-Specific Fields
        </button>
        <button type="button" 
                class="tab-button" 
                [class.active]="activeTab === 'attachments'"
                (click)="switchTab('attachments')">
          Attachments
        </button>
        <button type="button" 
                class="tab-button" 
                [class.active]="activeTab === 'preview'"
                (click)="switchTab('preview')">
          Preview
        </button>
      </div>
      
      <div class="tab-content">
        <!-- Bank-Specific Fields Tab -->
        <div *ngIf="activeTab === 'template'" class="tab-panel">
          <div *ngIf="hasBankSpecificFields()" class="bank-specific-content">
            <!-- Compact Header with Inline Sub-tabs -->
            <div class="compact-section-header">
              <div class="header-left">
                <h3 class="section-title">{{ selectedBankName }} - {{ selectedTemplateName }}</h3>
                <p class="section-subtitle">Bank-specific fields for {{ selectedPropertyType }} property valuation</p>
              </div>
              
              <!-- Inline Sub-tabs -->
              <div class="inline-sub-tabs" *ngIf="getBankSpecificFieldGroups().length > 1">
                <button type="button" 
                        *ngFor="let fieldGroup of getBankSpecificFieldGroups()" 
                        class="inline-sub-tab-button" 
                        [class.active]="activeBankSpecificTab === fieldGroup.groupName"
                        (click)="switchBankSpecificTab(fieldGroup.groupName)">
                  {{ fieldGroup.displayName }}
                  <span class="tab-field-count">({{ fieldGroup.fields.length }})</span>
                </button>
              </div>
            </div>

            <!-- Field Groups Content -->
            <div class="compact-field-groups">
              <!-- If multiple groups, show only active tab content -->
              <div *ngIf="getBankSpecificFieldGroups().length > 1">
                <div *ngFor="let fieldGroup of getBankSpecificFieldGroups()" 
                     [hidden]="activeBankSpecificTab !== fieldGroup.groupName"
                     class="field-group">
                  
                  <div class="fields-grid">
                    <div *ngFor="let field of fieldGroup.fields" 
                         [class]="'field-container grid-' + field.gridSize"
                         [class.field-error]="isFieldInvalid(field.fieldId)">
                      
                      <!-- Group Field (for complex fields with subFields) -->
                      <div *ngIf="field.fieldType === 'group'" class="form-field group-field">
                        <fieldset class="field-group-container">
                          <legend class="group-legend">
                            {{ field.uiDisplayName }}
                            <span class="required-indicator" *ngIf="field.isRequired">*</span>
                          </legend>
                          
                          <div class="group-fields-grid" *ngIf="field.subFields">
                            <div *ngFor="let subField of field.subFields" 
                                 [class]="'field-container grid-' + (subField.gridSize || 'full')"
                                 [class.field-error]="isFieldInvalid(subField.fieldId)">
                              
                              <!-- Sub-field Text Input -->
                              <div *ngIf="subField.fieldType === 'text'" class="form-field">
                                <label [for]="subField.fieldId" class="field-label">
                                  {{ subField.uiDisplayName }}
                                  <span class="required-indicator" *ngIf="subField.isRequired">*</span>
                                </label>
                                <input
                                  [id]="subField.fieldId"
                                  type="text"
                                  [formControlName]="subField.fieldId"
                                  [placeholder]="subField.placeholder"
                                  [readonly]="subField.isReadonly"
                                  [class.readonly-field]="subField.isReadonly"
                                  class="form-input"
                                />
                                <div class="field-help" *ngIf="subField.helpText">{{ subField.helpText }}</div>
                                <div class="field-error-message" *ngIf="getFieldError(subField.fieldId)">
                                  {{ getFieldError(subField.fieldId) }}
                                </div>
                              </div>

                              <!-- Sub-field Number Input -->
                              <div *ngIf="subField.fieldType === 'number' || subField.fieldType === 'currency'" class="form-field">
                                <label [for]="subField.fieldId" class="field-label">
                                  {{ subField.uiDisplayName }}
                                  <span class="required-indicator" *ngIf="subField.isRequired">*</span>
                                </label>
                                <input
                                  [id]="subField.fieldId"
                                  type="number"
                                  [formControlName]="subField.fieldId"
                                  [placeholder]="subField.placeholder"
                                  [min]="subField.validation?.min || null"
                                  [max]="subField.validation?.max || null"
                                  class="form-input"
                                />
                                <div class="field-help" *ngIf="subField.helpText">{{ subField.helpText }}</div>
                                <div class="field-error-message" *ngIf="getFieldError(subField.fieldId)">
                                  {{ getFieldError(subField.fieldId) }}
                                </div>
                              </div>

                              <!-- Sub-field Select Input -->
                              <div *ngIf="subField.fieldType === 'select'" class="form-field">
                                <label [for]="subField.fieldId" class="field-label">
                                  {{ subField.uiDisplayName }}
                                  <span class="required-indicator" *ngIf="subField.isRequired">*</span>
                                </label>
                                <select 
                                  [id]="subField.fieldId"
                                  [formControlName]="subField.fieldId"
                                  class="form-select">
                                  <option value="">{{ subField.placeholder || 'Select option' }}</option>
                                  <option *ngFor="let option of subField.options" [value]="option.value">
                                    {{ option.label }}
                                  </option>
                                </select>
                                <div class="field-help" *ngIf="subField.helpText">{{ subField.helpText }}</div>
                                <div class="field-error-message" *ngIf="getFieldError(subField.fieldId)">
                                  {{ getFieldError(subField.fieldId) }}
                                </div>
                              </div>
                              
                            </div>
                          </div>
                        </fieldset>
                        <div class="field-help" *ngIf="field.helpText">{{ field.helpText }}</div>
                      </div>
                      
                      <!-- Text Input -->
                      <div *ngIf="field.fieldType === 'text'" class="form-field">
                        <label [for]="field.fieldId" class="field-label">
                          {{ field.uiDisplayName }}
                          <span class="required-indicator" *ngIf="field.isRequired">*</span>
                        </label>
                        <input
                          [id]="field.fieldId"
                          type="text"
                          [formControlName]="field.fieldId"
                          [placeholder]="field.placeholder"
                          [readonly]="field.isReadonly"
                          [class.readonly-field]="field.isReadonly"
                          class="form-input"
                        />
                        <div class="field-help" *ngIf="field.helpText">{{ field.helpText }}</div>
                        <div class="field-error-message" *ngIf="getFieldError(field.fieldId)">
                          {{ getFieldError(field.fieldId) }}
                        </div>
                      </div>

                      <!-- Date Input -->
                      <div *ngIf="field.fieldType === 'date'" class="form-field">
                        <label [for]="field.fieldId" class="field-label">
                          {{ field.uiDisplayName }}
                          <span class="required-indicator" *ngIf="field.isRequired">*</span>
                        </label>
                        <input
                          [id]="field.fieldId"
                          type="date"
                          [formControlName]="field.fieldId"
                          class="form-input"
                        />
                        <div class="field-help" *ngIf="field.helpText">{{ field.helpText }}</div>
                        <div class="field-error-message" *ngIf="getFieldError(field.fieldId)">
                          {{ getFieldError(field.fieldId) }}
                        </div>
                      </div>

                      <!-- Number/Currency Input -->
                      <div *ngIf="field.fieldType === 'number' || field.fieldType === 'currency'" class="form-field">
                        <label [for]="field.fieldId" class="field-label">
                          {{ field.uiDisplayName }}
                          <span class="required-indicator" *ngIf="field.isRequired">*</span>
                        </label>
                        <input
                          [id]="field.fieldId"
                          type="number"
                          [formControlName]="field.fieldId"
                          [placeholder]="field.placeholder"
                          [min]="field.validation?.min || null"
                          [max]="field.validation?.max || null"
                          class="form-input"
                        />
                        <div class="field-help" *ngIf="field.helpText">{{ field.helpText }}</div>
                        <div class="field-error-message" *ngIf="getFieldError(field.fieldId)">
                          {{ getFieldError(field.fieldId) }}
                        </div>
                      </div>

                      <!-- Textarea Input -->
                      <div *ngIf="field.fieldType === 'textarea'" class="form-field">
                        <label [for]="field.fieldId" class="field-label">
                          {{ field.uiDisplayName }}
                          <span class="required-indicator" *ngIf="field.isRequired">*</span>
                        </label>
                        <textarea
                          [id]="field.fieldId"
                          [formControlName]="field.fieldId"
                          [placeholder]="field.placeholder"
                          class="form-textarea"
                          rows="3"
                        ></textarea>
                        <div class="field-help" *ngIf="field.helpText">{{ field.helpText }}</div>
                        <div class="field-error-message" *ngIf="getFieldError(field.fieldId)">
                          {{ getFieldError(field.fieldId) }}
                        </div>
                      </div>

                      <!-- Select Input -->
                      <div *ngIf="field.fieldType === 'select' || field.fieldType === 'select_dynamic'" class="form-field">
                        <label [for]="field.fieldId" class="field-label">
                          {{ field.uiDisplayName }}
                          <span class="required-indicator" *ngIf="field.isRequired">*</span>
                        </label>
                        <select 
                          [id]="field.fieldId"
                          [formControlName]="field.fieldId"
                          class="form-select">
                          <option value="">{{ field.placeholder || 'Select option' }}</option>
                          <option *ngFor="let option of field.options" [value]="option.value">
                            {{ option.label }}
                          </option>
                        </select>
                        <div class="field-help" *ngIf="field.helpText">{{ field.helpText }}</div>
                        <div class="field-error-message" *ngIf="getFieldError(field.fieldId)">
                          {{ getFieldError(field.fieldId) }}
                        </div>
                      </div>

                      <!-- Checkbox Input -->
                      <div *ngIf="field.fieldType === 'checkbox'" class="form-field checkbox-field">
                        <label [for]="field.fieldId" class="checkbox-label">
                          <input
                            [id]="field.fieldId"
                            type="checkbox"
                            [formControlName]="field.fieldId"
                            class="form-checkbox"
                          />
                          <span class="checkbox-text">
                            {{ field.uiDisplayName }}
                            <span class="required-indicator" *ngIf="field.isRequired">*</span>
                          </span>
                        </label>
                        <div class="field-help" *ngIf="field.helpText">{{ field.helpText }}</div>
                        <div class="field-error-message" *ngIf="getFieldError(field.fieldId)">
                          {{ getFieldError(field.fieldId) }}
                        </div>
                      </div>
                      
                    </div>
                  </div>
                </div>
              </div>

              <!-- If single group, show all content directly -->
              <div *ngIf="getBankSpecificFieldGroups().length === 1">
                <div *ngFor="let fieldGroup of getBankSpecificFieldGroups()" class="field-group">
                  <h4 class="field-group-title">{{ fieldGroup.displayName }}</h4>
                  
                  <!-- Same field templates as above - keeping existing structure for single group -->
                  <div class="fields-grid">
                    <!-- Abbreviated for brevity - same field templates as in the multi-group section -->
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- No bank-specific fields message -->
          <div *ngIf="!hasBankSpecificFields() && !isLoading" class="placeholder-content">
            <div class="placeholder-icon">üìã</div>
            <h3 class="placeholder-title">No Bank-Specific Fields</h3>
            <p class="placeholder-text">
              No additional fields are required for {{ selectedTemplateName || 'this template' }} from {{ selectedBankName }}.
              Only the common fields above are needed for this valuation report.
            </p>
          </div>
        </div>

        <!-- Attachments Tab -->
        <div *ngIf="activeTab === 'attachments'" class="tab-panel">
          <div class="placeholder-content">
            <div class="placeholder-icon">üìé</div>
            <h3 class="placeholder-title">Document Attachments</h3>
            <p class="placeholder-text">
              Upload property documents, photos, and supporting files here.
              This section will be implemented in the next phase.
            </p>
          </div>
        </div>

        <!-- Preview Tab -->
        <div *ngIf="activeTab === 'preview'" class="tab-panel">
          <div class="placeholder-content">
            <div class="placeholder-icon">üëÅÔ∏è</div>
            <h3 class="placeholder-title">Report Preview</h3>
            <p class="placeholder-text">
              Preview the complete valuation report before submission.
              This section will be implemented in the next phase.
            </p>
          </div>
        </div>
      </div>
    </div>

    <!-- Action Buttons -->
    <div class="form-actions">
      <div class="action-buttons">
        <button type="button" class="cancel-button" (click)="onCancel()">
          Cancel
        </button>
        <button type="button" class="save-draft-button" (click)="onSaveDraft()">
          Save Draft
        </button>
        <button type="submit" class="submit-button" [disabled]="reportForm.invalid">
          Save & Continue
        </button>
      </div>
    </div>

  </form>
</div>
