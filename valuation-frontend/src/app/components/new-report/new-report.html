<div class="new-report-container">
  <!-- Header Section -->
  <div class="page-header">
    <div class="header-content">
      <button class="back-button" (click)="cancelAndGoBack()">
        ‚Üê Back to Dashboard
      </button>
      <div class="page-title-section">
        <h1 class="page-title">Create New Report</h1>
        <p class="page-subtitle">Select a bank and template to get started</p>
      </div>
    </div>
  </div>

  <!-- Progress Indicator -->
  <div class="progress-steps">
    <div class="step" [class.active]="step >= 1" [class.completed]="step > 1">
      <div class="step-number">1</div>
      <div class="step-label">Select Bank</div>
    </div>
    <div class="step-connector" [class.completed]="step > 1"></div>
    <div class="step" [class.active]="step >= 2" [class.completed]="step > 2">
      <div class="step-number">2</div>
      <div class="step-label">Select Template</div>
    </div>
    <div class="step-connector" [class.completed]="step > 2"></div>
    <div class="step" [class.active]="step >= 3" [class.completed]="step > 3">
      <div class="step-number">3</div>
      <div class="step-label">PDF Upload</div>
    </div>
    <div class="step-connector" [class.completed]="step > 3"></div>
    <div class="step" [class.active]="step >= 4">
      <div class="step-number">4</div>
      <div class="step-label">Create Report</div>
    </div>
  </div>

  <!-- Loading State -->
  <div class="loading-container" *ngIf="isLoading">
    <div class="loading-spinner"></div>
    <p class="loading-text">Loading banks data...</p>
  </div>

  <!-- Step 1: Bank Selection -->
  <div class="step-content" *ngIf="!isLoading && step === 1">
    <div class="section-header">
      <h2 class="section-title">Select a Bank</h2>
      <p class="section-subtitle">Choose the bank for which you want to create a valuation report</p>
    </div>
    
    <div class="banks-grid">
      <div class="bank-card" 
           *ngFor="let bank of banks" 
           (click)="selectBank(bank)"
           [class.selected]="selectedBank?.bankCode === bank.bankCode"
           [style.--bank-color]="getBankThemeColor(bank.bankCode)">
        
        <!-- Bank Code Badge -->
        <div class="bank-header">
          <div class="bank-code-badge" [style.background-color]="getBankThemeColor(bank.bankCode)">
            {{ bank.bankCode }}
          </div>
        </div>

        <!-- Bank Information -->
        <div class="bank-content">
          <h3 class="bank-name">{{ bank.bankName }}</h3>
          <div class="template-count" *ngIf="bank.templates && bank.templates.length > 0">
            {{ bank.templates.length }} Templates
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Step 2: Template Selection -->
  <div class="step-content" *ngIf="!isLoading && step === 2">
    <div class="section-header">
      <button class="back-step-button" (click)="goBack()">
        ‚Üê Back to Bank Selection
      </button>
      <h2 class="section-title">Select Template</h2>
      <p class="section-subtitle">
        Choose a valuation template for <strong>{{ selectedBank?.bankName }}</strong>
      </p>
    </div>

    <div class="selected-bank-info">
      <div class="bank-chip">
        <span class="bank-code-badge-small" [style.background-color]="getBankThemeColor(selectedBank!.bankCode)">
          {{ selectedBank!.bankCode }}
        </span>
        <span class="bank-name">{{ selectedBank?.bankName }}</span>
      </div>
    </div>

    <div class="templates-grid" *ngIf="availableTemplates.length > 0">
      <div class="template-card" 
           *ngFor="let template of availableTemplates" 
           (click)="selectTemplate(template)"
           [class.selected]="selectedTemplate?.templateId === template.templateId"
           [class.active]="template.isActive">
        
        <!-- Template Icon -->
        <div class="template-icon-section">
          <div class="template-icon">{{ getPropertyTypeIcon(template.propertyType) }}</div>
        </div>

        <!-- Template Info -->
        <div class="template-content">
          <h3 class="template-name">{{ template.templateName }}</h3>
          <div class="template-type">{{ template.propertyType | titlecase }} Property</div>
          <div class="template-version">v{{ template.version }}</div>
        </div>
      </div>
    </div>

    <!-- No templates available -->
    <div class="no-templates" *ngIf="availableTemplates.length === 0">
      <div class="no-templates-icon">üìã</div>
      <h3 class="no-templates-title">No Templates Available</h3>
      <p class="no-templates-text">
        {{ selectedBank?.bankName }} doesn't have any specific templates. 
        You can proceed with a custom form.
      </p>
      <button class="proceed-button" (click)="proceedToForm()">
        Proceed with Custom Form
      </button>
    </div>
  </div>

  <!-- Step 3: PDF Upload (Optional) -->
  <div class="step-content" *ngIf="!isLoading && step === 3">
    <div class="section-header">
      <button class="back-step-button" (click)="goBack()">
        ‚Üê Back to Template Selection
      </button>
      <h2 class="section-title">Upload PDF to Auto-Fill (Optional)</h2>
      <p class="section-subtitle">
        Upload a property valuation PDF to automatically extract and fill form fields, or skip to start with an empty form
      </p>
    </div>

    <div class="selected-bank-info">
      <div class="bank-chip">
        <span class="bank-code-badge-small" [style.background-color]="getBankThemeColor(selectedBank!.bankCode)">
          {{ selectedBank!.bankCode }}
        </span>
        <span class="bank-name">{{ selectedBank?.bankName }}</span>
        <span class="separator">‚Ä¢</span>
        <span class="template-name">{{ selectedTemplate?.templateName }}</span>
      </div>
    </div>

    <!-- PDF Upload Options -->
    <div class="pdf-upload-section">
      <div class="upload-options">
        <!-- Skip PDF Upload Option -->
        <div class="upload-option-card" 
             (click)="skipPdfUpload()"
             [class.selected]="!uploadedPdf">
          <div class="option-icon-section">
            <div class="option-icon">üìù</div>
          </div>
          <div class="option-content">
            <h3 class="option-name">Start with Empty Form</h3>
            <div class="option-type">No pre-filled values</div>
            <div class="option-description">Fill all fields manually</div>
          </div>
        </div>

        <!-- PDF Upload Option -->
        <div class="upload-option-card" 
             [class.selected]="uploadedPdf"
             [class.processing]="isProcessingPdf">
          <div class="option-icon-section">
            <div class="option-icon" *ngIf="!uploadedPdf && !isProcessingPdf">üìÑ</div>
            <div class="option-icon" *ngIf="uploadedPdf && !isProcessingPdf">‚úÖ</div>
            <div class="loading-spinner-small" *ngIf="isProcessingPdf"></div>
          </div>
          <div class="option-content">
            <h3 class="option-name">Upload PDF Document</h3>
            <div class="option-type" *ngIf="!uploadedPdf">Auto-fill from PDF</div>
            <div class="option-type" *ngIf="uploadedPdf">{{ uploadedPdf.name }}</div>
            <div class="option-description" *ngIf="!uploadedPdf">Upload valuation report to extract data</div>
            <div class="option-description" *ngIf="uploadedPdf && extractedFields">
              Extracted {{ Object.keys(extractedFields).length }} fields
            </div>
          </div>
          
          <!-- PDF Upload Area -->
          <div class="pdf-upload-area" 
               *ngIf="!uploadedPdf && !isProcessingPdf"
               (click)="$event.stopPropagation(); onUploadAreaClick(); fileInput.click()"
               (dragover)="onDragOver($event)"
               (dragleave)="onDragLeave($event)"
               (drop)="onDrop($event)">
            <div class="upload-content">
              <div class="upload-icon">üìÅ</div>
              <div class="upload-text">
                <p class="upload-primary">Click to browse or drag & drop</p>
                <p class="upload-secondary">PDF files only, max 10MB</p>
              </div>
            </div>
          </div>

          <!-- Processing Status -->
          <div class="processing-status" *ngIf="isProcessingPdf">
            <p class="processing-text">{{ processingStatus }}</p>
          </div>

          <!-- Extracted Fields Preview -->
          <div class="extracted-fields-preview" *ngIf="uploadedPdf && extractedFields && !isProcessingPdf">
            <h4 class="preview-title">Extracted Data Preview:</h4>
            <div class="field-previews">
              <div class="field-preview" *ngFor="let field of getExtractedFieldsArray() | slice:0:3">
                <span class="field-label">{{ field.label }}:</span>
                <span class="field-value">{{ field.value }}</span>
              </div>
              <div class="more-fields" *ngIf="Object.keys(extractedFields).length > 3">
                +{{ Object.keys(extractedFields).length - 3 }} more fields
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Hidden file input -->
      <input #fileInput
             type="file"
             accept=".pdf"
             style="display: none"
             (change)="onFileSelected($event)">
    </div>
  </div>

  <!-- Step 4: Ready to Proceed -->
  <div class="step-content" *ngIf="!isLoading && step === 4 && selectedTemplate">
    <div class="section-header">
      <button class="back-step-button" (click)="goBack()">
        ‚Üê Back to Custom Template Selection
      </button>
      <h2 class="section-title">Ready to Create Report</h2>
      <p class="section-subtitle">Review your selections and proceed to the report form</p>
    </div>

    <!-- Action Buttons at Top -->
    <div class="action-buttons-top">
      <button class="cancel-button" (click)="cancelAndGoBack()">
        Cancel
      </button>
      <button class="proceed-button primary" (click)="proceedToForm()">
        Create Report Form
      </button>
    </div>

    <div class="selection-summary">
      <div class="summary-card">
        <h3 class="summary-title">Your Selections</h3>
        
        <div class="selection-item">
          <div class="selection-label">Bank:</div>
          <div class="selection-value">
            <span class="bank-code-badge-small" [style.background-color]="getBankThemeColor(selectedBank!.bankCode)">
              {{ selectedBank!.bankCode }}
            </span>
            {{ selectedBank?.bankName }}
          </div>
        </div>

        <div class="selection-item">
          <div class="selection-label">Template:</div>
          <div class="selection-value">
            <span class="template-icon">{{ getPropertyTypeIcon(selectedTemplate.propertyType) }}</span>
            {{ selectedTemplate.templateName }}
          </div>
        </div>

        <div class="selection-item">
          <div class="selection-label">Property Type:</div>
          <div class="selection-value">{{ selectedTemplate.propertyType | titlecase }}</div>
        </div>

        <div class="selection-item" *ngIf="uploadedPdf">
          <div class="selection-label">PDF Document:</div>
          <div class="selection-value">
            <span class="pdf-badge">üìÑ {{ uploadedPdf.name }}</span>
          </div>
        </div>

        <div class="selection-item" *ngIf="uploadedPdf && extractedFields">
          <div class="selection-label">Extracted Fields:</div>
          <div class="selection-value">
            <span class="fields-count-badge">{{ Object.keys(extractedFields).length }} fields extracted</span>
          </div>
        </div>

        <div class="selection-item" *ngIf="!uploadedPdf">
          <div class="selection-label">PDF Document:</div>
          <div class="selection-value">
            <span class="no-pdf-badge">None (Empty form)</span>
          </div>
        </div>
      </div>
    </div>


  </div>
</div>
